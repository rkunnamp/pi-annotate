# Pi Annotate Architecture

This document explains the internal architecture and message flow of pi-annotate.

## Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              Pi Annotate                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  â”‚                                    â”‚                      â”‚
â”‚   Pi Terminal    â”‚                                    â”‚   Chrome Browser     â”‚
â”‚                  â”‚                                    â”‚                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚      /tmp/pi-annotate.sock        â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚            â”‚  â”‚                                    â”‚  â”‚                â”‚  â”‚
â”‚  â”‚  index.ts  â”‚â—„â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Unix Socket â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â–ºâ”‚    host.cjs    â”‚  â”‚
â”‚  â”‚            â”‚  â”‚                                    â”‚  â”‚  (Native Host) â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                                    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                  â”‚                                    â”‚          â”‚           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                    â”‚   Native Messaging   â”‚
                                                        â”‚          â”‚           â”‚
                                                        â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
                                                        â”‚  â”‚                â”‚  â”‚
                                                        â”‚  â”‚ background.ts  â”‚  â”‚
                                                        â”‚  â”‚                â”‚  â”‚
                                                        â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
                                                        â”‚          â”‚           â”‚
                                                        â”‚  Chrome Messages     â”‚
                                                        â”‚          â”‚           â”‚
                                                        â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
                                                        â”‚  â”‚                â”‚  â”‚
                                                        â”‚  â”‚    App.tsx     â”‚  â”‚
                                                        â”‚  â”‚   (Toolbar)    â”‚  â”‚
                                                        â”‚  â”‚                â”‚  â”‚
                                                        â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
                                                        â”‚                      â”‚
                                                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Components

| Component | Location | Purpose |
|-----------|----------|---------|
| Pi Extension | `index.ts` | Registers `/annotate` command and `annotate` tool, manages socket connection |
| Native Host | `chrome-extension/native/host.cjs` | Bridges Unix socket â†” Chrome native messaging |
| Background Script | `chrome-extension/src/background.ts` | Routes messages between native host and content script |
| Content Script | `chrome-extension/src/content.tsx` | Entry point, mounts React app into page |
| App Component | `chrome-extension/src/components/App.tsx` | Main React component, state management, message handling |

## Flow 1: `/annotate` Command (Browser-First)

This is the recommended flow for users who want to annotate from the browser.

```
  User                 Pi Extension              Native Host           Chrome Extension
   â”‚                      â”‚                          â”‚                        â”‚
   â”‚  /annotate           â”‚                          â”‚                        â”‚
   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                          â”‚                        â”‚
   â”‚                      â”‚                          â”‚                        â”‚
   â”‚                      â”‚  connectToHost()         â”‚                        â”‚
   â”‚                      â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                        â”‚
   â”‚                      â”‚         connected        â”‚                        â”‚
   â”‚                      â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                        â”‚
   â”‚                      â”‚                          â”‚                        â”‚
   â”‚                      â”‚  START_ANNOTATION        â”‚                        â”‚
   â”‚                      â”‚  (no id)                 â”‚                        â”‚
   â”‚                      â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚  START_ANNOTATION      â”‚
   â”‚                      â”‚                          â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
   â”‚                      â”‚                          â”‚                        â”‚
   â”‚  "Annotation mode    â”‚                          â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚   opened in Chrome"  â”‚                          â”‚            â”‚  Toolbar  â”‚
   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                          â”‚            â”‚   Opens   â”‚
   â”‚                      â”‚                          â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚                      â”‚                          â”‚                        â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚                      â”‚                          â”‚                        â”‚
   â”‚                 User annotates elements in browser...                    â”‚
   â”‚                      â”‚                          â”‚                        â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚                      â”‚                          â”‚                        â”‚
   â”‚                      â”‚                          â”‚  USER_MESSAGE          â”‚
   â”‚                      â”‚                          â”‚  + annotations         â”‚
   â”‚                      â”‚  USER_MESSAGE            â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
   â”‚                      â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                        â”‚
   â”‚                      â”‚                          â”‚                        â”‚
   â”‚                      â”‚  pi.sendUserMessage()    â”‚                        â”‚
   â”‚                      â”‚  (injected into chat)    â”‚                        â”‚
   â”‚                      â”‚                          â”‚                        â”‚
   â”‚                      â”‚                          â”‚                        â”‚
   â”‚              Agent processes and responds...                             â”‚
   â”‚                      â”‚                          â”‚                        â”‚
   â”‚                      â”‚                          â”‚                        â”‚
   â”‚                      â”‚  AGENT_RESPONSE          â”‚                        â”‚
   â”‚                      â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚  AGENT_RESPONSE        â”‚
   â”‚                      â”‚                          â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
   â”‚                      â”‚                          â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚                      â”‚                          â”‚            â”‚  Chat     â”‚
   â”‚                      â”‚                          â”‚            â”‚  Panel    â”‚
   â”‚                      â”‚                          â”‚            â”‚  Shows    â”‚
   â”‚                      â”‚                          â”‚            â”‚  Response â”‚
   â”‚                      â”‚                          â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚                      â”‚                          â”‚                        â”‚
   â–¼                      â–¼                          â–¼                        â–¼
```

**Key Points:**
- Command is fire-and-forget (returns immediately)
- No `id` in START_ANNOTATION â†’ browser uses USER_MESSAGE flow
- Annotations are injected into the conversation via `pi.sendUserMessage()`
- Enables bidirectional chat in the browser

## Flow 2: `annotate` Tool (LLM-Invoked)

This flow is used when the LLM decides to invoke the annotation tool.

```
  User                 Pi/LLM                 Native Host           Chrome Extension
   â”‚                      â”‚                          â”‚                        â”‚
   â”‚  "Show me the        â”‚                          â”‚                        â”‚
   â”‚   issues on this     â”‚                          â”‚                        â”‚
   â”‚   page"              â”‚                          â”‚                        â”‚
   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                          â”‚                        â”‚
   â”‚                      â”‚                          â”‚                        â”‚
   â”‚                      â”‚  annotate({ url })       â”‚                        â”‚
   â”‚                      â”‚  [tool call]             â”‚                        â”‚
   â”‚                      â”‚                          â”‚                        â”‚
   â”‚                      â”‚  connectToHost()         â”‚                        â”‚
   â”‚                      â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                        â”‚
   â”‚                      â”‚                          â”‚                        â”‚
   â”‚                      â”‚  START_ANNOTATION        â”‚                        â”‚
   â”‚                      â”‚  (with id: 12345)        â”‚                        â”‚
   â”‚                      â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚  START_ANNOTATION      â”‚
   â”‚                      â”‚                          â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
   â”‚                      â”‚                          â”‚                        â”‚
   â”‚                      â”‚         â³ waiting...    â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚                      â”‚                          â”‚            â”‚  Toolbar  â”‚
   â”‚                      â”‚                          â”‚            â”‚   Opens   â”‚
   â”‚                      â”‚                          â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚                      â”‚                          â”‚                        â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚                      â”‚                          â”‚                        â”‚
   â”‚                 User annotates elements in browser...                    â”‚
   â”‚                      â”‚                          â”‚                        â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚                      â”‚                          â”‚                        â”‚
   â”‚                      â”‚                          â”‚  ANNOTATIONS_COMPLETE  â”‚
   â”‚                      â”‚                          â”‚  (requestId: 12345)    â”‚
   â”‚                      â”‚  ANNOTATIONS_COMPLETE    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
   â”‚                      â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                        â”‚
   â”‚                      â”‚                          â”‚                        â”‚
   â”‚                      â”‚  pendingToolResolve()    â”‚                        â”‚
   â”‚                      â”‚                          â”‚                        â”‚
   â”‚                      â”‚  Tool returns result     â”‚                        â”‚
   â”‚                      â”‚  to LLM with formatted   â”‚                        â”‚
   â”‚                      â”‚  annotations             â”‚                        â”‚
   â”‚                      â”‚                          â”‚                        â”‚
   â”‚              LLM processes annotations...                                â”‚
   â”‚                      â”‚                          â”‚                        â”‚
   â”‚  "I see 3 issues:    â”‚                          â”‚                        â”‚
   â”‚   1. Button too      â”‚                          â”‚                        â”‚
   â”‚   small..."          â”‚                          â”‚                        â”‚
   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                          â”‚                        â”‚
   â”‚                      â”‚                          â”‚                        â”‚
   â–¼                      â–¼                          â–¼                        â–¼
```

**Key Points:**
- Tool blocks until user completes annotations (or timeout)
- `id` in START_ANNOTATION â†’ browser uses ANNOTATIONS_COMPLETE flow
- Result is returned directly to the LLM as structured data
- LLM can then process and respond to the annotations

## Message Protocol

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           MESSAGE TYPES                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  Pi â†’ Chrome                         Chrome â†’ Pi                             â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                         â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                             â”‚
â”‚                                                                              â”‚
â”‚  START_ANNOTATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º    ANNOTATIONS_COMPLETE â—„â”€â”€ (tool only)   â”‚
â”‚  â”œâ”€ id?: number                      â”œâ”€ requestId: number                   â”‚
â”‚  â””â”€ url?: string                     â””â”€ result: AnnotationResult            â”‚
â”‚                                                                              â”‚
â”‚  AGENT_RESPONSE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º    USER_MESSAGE â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ (command/chat)â”‚
â”‚  â””â”€ content: string                  â”œâ”€ content: string                     â”‚
â”‚                                      â”œâ”€ url?: string                        â”‚
â”‚  ERROR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º    â”œâ”€ annotations?: Annotation[]          â”‚
â”‚  â””â”€ message: string                  â””â”€ screenshots?: Screenshot[]          â”‚
â”‚                                      END_CHAT â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ (chat closed) â”‚
â”‚                                                                              â”‚
â”‚  (Chrome internal, not sent to Pi)                                          â”‚
â”‚  TOGGLE_TOOLBAR â”€â”€ used by icon click / Cmd/Ctrl+Shift+A                    â”‚
â”‚                                                                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  KEY INSIGHT: The presence of `id` in START_ANNOTATION determines the flow: â”‚
â”‚                                                                              â”‚
â”‚    â€¢ id PRESENT  â†’ Tool invocation  â†’ Browser sends ANNOTATIONS_COMPLETE    â”‚
â”‚    â€¢ id ABSENT   â†’ Command (/annotate) â†’ Browser sends USER_MESSAGE         â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Message Format

All messages are newline-delimited JSON over the Unix socket:

```
{"type":"START_ANNOTATION","url":"http://localhost:3000"}\n
{"type":"USER_MESSAGE","content":"Fix this button","annotations":[...]}\n
```

## Screenshot Capture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         SCREENSHOT MODES                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  1. Viewport Screenshot                                                      â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚     â”‚ Click â›¶ icon â”‚ â”€â”€â”€â–º â”‚ background   â”‚ â”€â”€â”€â–º â”‚ Full viewportâ”‚            â”‚
â”‚     â”‚              â”‚      â”‚ captureTab() â”‚      â”‚ PNG returned â”‚            â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                                                              â”‚
â”‚  2. Area Screenshot                                                          â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚     â”‚ Click âŒ— icon â”‚ â”€â”€â”€â–º â”‚ User drags   â”‚ â”€â”€â”€â–º â”‚ Cropped PNG  â”‚            â”‚
â”‚     â”‚              â”‚      â”‚ selection    â”‚      â”‚ from region  â”‚            â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                                                              â”‚
â”‚  3. Element Screenshot (attached to annotation)                              â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚     â”‚ Check box in â”‚ â”€â”€â”€â–º â”‚ Capture with â”‚ â”€â”€â”€â–º â”‚ Screenshot   â”‚            â”‚
â”‚     â”‚ popup: â˜‘     â”‚      â”‚ bounding box â”‚      â”‚ in annotationâ”‚            â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                                                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  Technical: Uses chrome.tabs.captureVisibleTab() API                        â”‚
â”‚  Format: Base64 PNG data URLs                                                â”‚
â”‚  HiDPI: Automatically scales for devicePixelRatio                           â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Activation Methods

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        WAYS TO OPEN TOOLBAR                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  1. /annotate command (RECOMMENDED - establishes connection)                 â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚     â”‚ Pi Terminal â”‚ â”€â”€â”€â–º â”‚ Native Host â”‚ â”€â”€â”€â–º â”‚   Chrome    â”‚               â”‚
â”‚     â”‚ /annotate   â”‚      â”‚             â”‚      â”‚  Toolbar âœ“  â”‚               â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                                                                              â”‚
â”‚  2. Extension icon click (after /annotate)                                   â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                          â”‚
â”‚     â”‚   Click ğŸ”²   â”‚ â”€â”€â”€â–º TOGGLE_TOOLBAR â”€â”€â”€â–º Toolbar toggles                â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                          â”‚
â”‚                                                                              â”‚
â”‚  3. Keyboard shortcut (after /annotate)                                      â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                     â”‚
â”‚     â”‚ Cmd/Ctrl+Shift+A â”‚ â”€â”€â”€â–º TOGGLE_TOOLBAR â”€â”€â”€â–º Toolbar toggles           â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                     â”‚
â”‚                                                                              â”‚
â”‚  4. LLM tool invocation                                                      â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚     â”‚ "Open the   â”‚      â”‚   annotate  â”‚      â”‚   Chrome    â”‚               â”‚
â”‚     â”‚  annotation â”‚ â”€â”€â”€â–º â”‚    tool     â”‚ â”€â”€â”€â–º â”‚  Toolbar âœ“  â”‚               â”‚
â”‚     â”‚  tool"      â”‚      â”‚   called    â”‚      â”‚  (waiting)  â”‚               â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Socket Lifecycle

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         CONNECTION LIFECYCLE                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  Chrome Extension Loads                                                      â”‚
â”‚          â”‚                                                                   â”‚
â”‚          â–¼                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                          â”‚
â”‚  â”‚  Native Host  â”‚ â—„â”€â”€â”€ Starts, creates socket at /tmp/pi-annotate.sock     â”‚
â”‚  â”‚    Starts     â”‚                                                          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                                          â”‚
â”‚          â”‚                                                                   â”‚
â”‚          â–¼                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                          â”‚
â”‚  â”‚   Listening   â”‚ â—„â”€â”€â”€ Waiting for Pi to connect                           â”‚
â”‚  â”‚   on Socket   â”‚                                                          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                                          â”‚
â”‚          â”‚                                                                   â”‚
â”‚          â”‚  User runs /annotate or LLM calls tool                           â”‚
â”‚          â–¼                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                          â”‚
â”‚  â”‚  Pi Connects  â”‚ â—„â”€â”€â”€ connectToHost() in index.ts                         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                                          â”‚
â”‚          â”‚                                                                   â”‚
â”‚          â–¼                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                          â”‚
â”‚  â”‚   Connected   â”‚ â—„â”€â”€â”€ Bidirectional communication active                  â”‚
â”‚  â”‚   & Active    â”‚                                                          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                                          â”‚
â”‚          â”‚                                                                   â”‚
â”‚          â”‚  Pi session ends                                                  â”‚
â”‚          â–¼                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                          â”‚
â”‚  â”‚ Pi Disconnectsâ”‚ â—„â”€â”€â”€ session_shutdown handler destroys socket            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                                          â”‚
â”‚          â”‚                                                                   â”‚
â”‚          â–¼                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                          â”‚
â”‚  â”‚   Listening   â”‚ â—„â”€â”€â”€ Ready for next Pi session                           â”‚
â”‚  â”‚    Again      â”‚                                                          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                          â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## File Structure

```
pi-annotate/
â”œâ”€â”€ index.ts                 # Pi extension entry point
â”œâ”€â”€ types.ts                 # Shared TypeScript types  
â”œâ”€â”€ generate-output.ts       # Markdown output formatter
â”œâ”€â”€ package.json
â”‚
â””â”€â”€ chrome-extension/
    â”œâ”€â”€ manifest.json        # Chrome extension manifest
    â”œâ”€â”€ package.json
    â”œâ”€â”€ esbuild.config.mjs   # Build configuration
    â”œâ”€â”€ tsconfig.json
    â”‚
    â”œâ”€â”€ native/
    â”‚   â”œâ”€â”€ host.cjs         # Native messaging host (Unix socket â†” Chrome)
    â”‚   â””â”€â”€ install.sh       # macOS installation script
    â”‚
    â””â”€â”€ src/
        â”œâ”€â”€ background.ts    # Service worker (message routing)
        â”œâ”€â”€ content.tsx      # Content script entry point
        â”œâ”€â”€ types.ts         # Re-exports from root types.ts
        â”‚
        â”œâ”€â”€ components/
        â”‚   â”œâ”€â”€ App.tsx          # Main React app, state management
        â”‚   â”œâ”€â”€ Toolbar.tsx      # Annotation toolbar UI
        â”‚   â”œâ”€â”€ ChatPanel.tsx    # Bidirectional chat UI
        â”‚   â”œâ”€â”€ AnnotationPopup.tsx  # Comment input popup
        â”‚   â””â”€â”€ icons.tsx        # SVG icons
        â”‚
        â”œâ”€â”€ styles/
        â”‚   â”œâ”€â”€ toolbar.module.scss  # Toolbar styles
        â”‚   â”œâ”€â”€ popup.module.scss    # Annotation popup styles
        â”‚   â””â”€â”€ chat.module.scss     # Chat panel styles
        â”‚
        â””â”€â”€ utils/
            â”œâ”€â”€ element-identification.ts  # DOM element analysis
            â”œâ”€â”€ screenshot.ts              # Screenshot capture & crop utilities
            â””â”€â”€ storage.ts                 # localStorage persistence
```
